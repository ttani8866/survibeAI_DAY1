# 002_Google認証機能

## 1. ユーザーニーズ

### 背景
- ユーザーがサービスを利用するために安全な認証システムが必要
- パスワード管理の負担を軽減するため、Googleアカウントでの認証を提供
- ユーザー情報を永続化し、パーソナライズされた体験を提供

### 期待される体験
- ワンクリックでGoogleアカウントを使ってログインできる
- ログイン状態がヘッダーに表示され、現在の状態が一目でわかる
- 認証が必要なページには未ログインユーザーがアクセスできない
- いつでも簡単にログアウトできる

---

## 2. 仕様要件

### 2.1 画面仕様

#### ログイン画面（/auth/signin）
| 項目 | 仕様 |
|------|------|
| URL | `/auth/signin` |
| 機能 | Googleログインボタン表示 |
| 遷移先 | ログイン成功後 → `/dashboard` |

#### ダッシュボード（/dashboard）
| 項目 | 仕様 |
|------|------|
| URL | `/dashboard` |
| アクセス制限 | 認証済みユーザーのみ |
| 未認証時 | `/auth/signin` にリダイレクト |

#### ヘッダー認証状態表示
| 状態 | 表示内容 |
|------|---------|
| 未ログイン | 「ログイン」ボタン |
| ログイン中 | アバター画像、ユーザー名、「ログアウト」ボタン |

### 2.2 データベース仕様

#### Userモデル（MongoDB/Mongoose）
| フィールド | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| name | String | ✓ | ユーザー名 |
| email | String | ✓ | メールアドレス（一意） |
| image | String | - | プロフィール画像URL |
| role | String | ✓ | ユーザー権限（default: "user"） |
| createdAt | Date | ✓ | 登録日時 |

### 2.3 認証フロー

```
[未認証ユーザー]
    ↓
[/auth/signin] Googleログインボタンクリック
    ↓
[Google OAuth] 認証画面
    ↓
[コールバック] /api/auth/callback/google
    ↓
[NextAuth] セッション作成
    ↓
[/dashboard] ダッシュボードにリダイレクト
```

---

## 3. 処理手順設計

### 3.1 ファイル構成

```
src/
├── auth.ts                      # NextAuth v5 設定
├── middleware.ts                # 認証ミドルウェア
├── app/
│   ├── api/
│   │   └── auth/
│   │       └── [...nextauth]/
│   │           └── route.ts     # Auth API Route
│   ├── auth/
│   │   └── signin/
│   │       └── page.tsx         # ログイン画面
│   └── dashboard/
│       └── page.tsx             # ダッシュボード
├── components/
│   └── AuthHeader.tsx           # 認証状態表示ヘッダー
└── models/
    └── User.ts                  # Mongooseモデル
```

### 3.2 環境変数

```env
AUTH_SECRET=（自動生成済み）
AUTH_GOOGLE_ID=（Google Cloud Consoleから取得）
AUTH_GOOGLE_SECRET=（Google Cloud Consoleから取得）
```

### 3.3 Google Cloud Console 設定

承認済みリダイレクトURI:
- 開発: `http://localhost:3000/api/auth/callback/google`
- 本番: `https://survibe-ai-day-1.vercel.app/api/auth/callback/google`

---

## 4. 技術スタック

- NextAuth.js v5 (Auth.js)
- Google OAuth 2.0
- MongoDB + Mongoose
- Next.js Middleware

