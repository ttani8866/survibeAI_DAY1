# 003_オーナー管理画面

## 1. ユーザーニーズ

### 背景
- サービス運営者（管理者）がユーザーやお問合せを一元管理できる画面が必要
- 一般ユーザーが誤って管理機能にアクセスできないようセキュリティを確保する必要がある
- サービスの利用状況を一目で把握できるダッシュボードが必要

### 期待される体験
- 管理者（role: "admin"）はログイン後、管理画面にアクセスして各種管理作業を行える
- ダッシュボードで総ユーザー数、総お問合せ数などの統計情報を確認できる
- ユーザー一覧から権限変更や削除が行える
- お問合せ一覧から詳細確認や削除が行える
- 一般ユーザーがアクセスした場合は403エラー画面が表示される

---

## 2. 仕様要件

### 2.1 画面仕様

#### ダッシュボード画面（/admin）
| 項目 | 仕様 |
|------|------|
| URL | `/admin` |
| アクセス条件 | 管理者（role: "admin"）のみ |
| 統計カード | 総ユーザー数、総お問合せ数 |
| UIコンポーネント | MUI Card |
| レスポンシブ | モバイル対応 |

#### ユーザー管理画面（/admin/users）
| 項目 | 仕様 |
|------|------|
| URL | `/admin/users` |
| アクセス条件 | 管理者（role: "admin"）のみ |
| 表示内容 | ユーザー一覧（DataGrid） |
| 操作 | 権限変更（user ↔ admin）、削除 |
| UIコンポーネント | MUI DataGrid |

#### お問合せ管理画面（/admin/contacts）
| 項目 | 仕様 |
|------|------|
| URL | `/admin/contacts` |
| アクセス条件 | 管理者（role: "admin"）のみ |
| 表示内容 | お問合せ一覧（DataGrid） |
| 操作 | 詳細表示（ダイアログ）、削除 |
| UIコンポーネント | MUI DataGrid, Dialog |

#### 403エラー画面
| 項目 | 仕様 |
|------|------|
| 表示条件 | 一般ユーザーが管理画面にアクセスした場合 |
| 内容 | アクセス権限がない旨のメッセージ |
| 遷移 | ダッシュボードへ戻るボタン |

### 2.2 API仕様

#### GET /api/admin/stats
| 項目 | 内容 |
|------|------|
| メソッド | GET |
| アクセス条件 | 管理者のみ |
| 成功レスポンス | `{ totalUsers: number, totalContacts: number }` |
| エラーレスポンス | `{ error: "エラー内容" }` |

#### GET /api/admin/users
| 項目 | 内容 |
|------|------|
| メソッド | GET |
| アクセス条件 | 管理者のみ |
| 成功レスポンス | `{ users: IUser[] }` |
| エラーレスポンス | `{ error: "エラー内容" }` |

#### PUT /api/admin/users/[id]
| 項目 | 内容 |
|------|------|
| メソッド | PUT |
| アクセス条件 | 管理者のみ |
| リクエストボディ | `{ role: "user" | "admin" }` |
| 成功レスポンス | `{ user: IUser }` |
| エラーレスポンス | `{ error: "エラー内容" }` |

#### DELETE /api/admin/users/[id]
| 項目 | 内容 |
|------|------|
| メソッド | DELETE |
| アクセス条件 | 管理者のみ |
| 成功レスポンス | `{ message: "削除完了" }` |
| エラーレスポンス | `{ error: "エラー内容" }` |

#### GET /api/admin/contacts
| 項目 | 内容 |
|------|------|
| メソッド | GET |
| アクセス条件 | 管理者のみ |
| 成功レスポンス | `{ contacts: IContact[] }` |
| エラーレスポンス | `{ error: "エラー内容" }` |

#### DELETE /api/admin/contacts/[id]
| 項目 | 内容 |
|------|------|
| メソッド | DELETE |
| アクセス条件 | 管理者のみ |
| 成功レスポンス | `{ message: "削除完了" }` |
| エラーレスポンス | `{ error: "エラー内容" }` |

### 2.3 権限チェック

#### セッション拡張
NextAuthのセッションにユーザーのroleを含める必要がある

| フィールド | 型 | 説明 |
|-----------|-----|------|
| session.user.role | "user" \| "admin" | ユーザーの権限 |
| session.user.id | string | ユーザーのMongoDB ID |

#### ミドルウェアでの保護
- `/admin/*` パスへのアクセス時に認証チェック
- API Route側でも管理者権限チェックを実施（二重チェック）

---

## 3. 処理手順設計

### 3.1 認証・認可フロー

```
[ユーザー] /admin/* にアクセス
    ↓
[Middleware] JWT検証
    ↓ (未認証 → /auth/signin へリダイレクト)
    ↓ (認証済み)
[Page] セッション取得
    ↓
[Page] role === "admin" チェック
    ↓ (admin以外 → 403エラー画面表示)
    ↓ (admin)
[Page] API呼び出し・管理画面表示
```

### 3.2 ダッシュボード処理フロー

```
[管理者] /admin にアクセス
    ↓
[ダッシュボード] 認可チェック
    ↓ (権限なし → 403表示)
    ↓ (OK)
[ダッシュボード] GET /api/admin/stats 呼び出し
    ↓
[API] MongoDB から User.countDocuments(), Contact.countDocuments()
    ↓
[ダッシュボード] 統計カード表示
```

### 3.3 ユーザー管理処理フロー

```
[管理者] /admin/users にアクセス
    ↓
[ユーザー管理] 認可チェック → GET /api/admin/users
    ↓
[DataGrid] ユーザー一覧表示
    ↓
[管理者] 権限変更または削除ボタンクリック
    ↓
[API] PUT または DELETE /api/admin/users/[id]
    ↓
[ユーザー管理] データ再取得・画面更新
```

### 3.4 お問合せ管理処理フロー

```
[管理者] /admin/contacts にアクセス
    ↓
[お問合せ管理] 認可チェック → GET /api/admin/contacts
    ↓
[DataGrid] お問合せ一覧表示
    ↓
[管理者] 詳細表示または削除ボタンクリック
    ↓
(詳細表示の場合)
[Dialog] お問合せ詳細ダイアログ表示
    ↓
(削除の場合)
[API] DELETE /api/admin/contacts/[id]
    ↓
[お問合せ管理] データ再取得・画面更新
```

### 3.5 ファイル構成

```
src/
├── app/
│   ├── admin/
│   │   ├── page.tsx              # ダッシュボード
│   │   ├── users/
│   │   │   └── page.tsx          # ユーザー管理
│   │   ├── contacts/
│   │   │   └── page.tsx          # お問合せ管理
│   │   └── forbidden/
│   │       └── page.tsx          # 403エラー画面
│   └── api/
│       └── admin/
│           ├── stats/
│           │   └── route.ts      # 統計API
│           ├── users/
│           │   ├── route.ts      # ユーザー一覧API
│           │   └── [id]/
│           │       └── route.ts  # ユーザー個別操作API
│           └── contacts/
│               ├── route.ts      # お問合せ一覧API
│               └── [id]/
│                   └── route.ts  # お問合せ個別操作API
├── components/
│   └── AdminLayout.tsx           # 管理画面共通レイアウト
└── middleware.ts                 # 権限チェック追加
```

---

## 4. 実装状態

✅ **実装完了**

- [x] MUI DataGridインストール（@mui/x-data-grid）
- [x] NextAuthにroleをセッションに含める修正（jwt/sessionコールバック追加）
- [x] middlewareにadmin権限チェック追加（/admin/*パス保護）
- [x] Admin API Routes作成（stats, users, contacts）
- [x] 管理画面ページ作成（/admin, /admin/users, /admin/contacts）
- [x] 403エラーページ作成（/admin/forbidden）
- [x] 型定義ファイル作成（src/types/next-auth.d.ts）
- [x] 管理者権限チェックユーティリティ作成（src/lib/adminAuth.ts）

